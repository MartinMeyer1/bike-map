<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BikeMap MVT Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #map { 
            height: 100vh; 
            width: 100%; 
        }
        
        .demo-header {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
        }
        
        .demo-header h2 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .demo-header p {
            margin: 0 0 10px 0;
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 200px;
        }
        
        .controls h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: #34495e;
            font-size: 14px;
        }
        
        .control-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }
        
        .opacity-display {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .stats {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .trail-popup {
            font-family: inherit;
        }
        
        .trail-popup h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
        }
        
        .trail-popup .trail-level {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="demo-header">
        <h2>üöµ BikeMap MVT Demo</h2>
        <p>Interactive demonstration of Mountain Bike Vector Tiles served by Go backend with PostGIS storage.</p>
        <p><strong>Features:</strong> Real-time tile rendering, Swiss topographic basemap, trail difficulty levels.</p>
    </div>
    
    <div class="controls">
        <h3>‚öôÔ∏è Controls</h3>
        
        <div class="control-group">
            <label>
                <input type="checkbox" id="mvtLayer" checked>
                Show Trail Layer
            </label>
        </div>
        
        <div class="control-group">
            <label>
                Trail Opacity: <span class="opacity-display" id="opacityValue">0.8</span>
            </label>
            <input type="range" id="opacity" min="0" max="1" step="0.1" value="0.8">
        </div>
        
        <div class="control-group">
            <label>
                <input type="checkbox" id="showTrailCenter" checked>
                Show Trail Marker
            </label>
        </div>
    </div>
    
    <div class="stats" id="stats">
        <div>Tiles loaded: <span id="tileCount">0</span></div>
        <div>Features found: <span id="featureCount">0</span></div>
        <div>Backend: localhost:8090</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>
    
    <script>
        // Statistics tracking
        let tileLoadCount = 0;
        let totalFeatures = 0;
        
        // Initialize map centered on trail location
        const map = L.map('map').fitBounds([[46.127811, 7.329435], [46.2277, 7.447113]]);

        // Add trail center marker for reference
        const trailMarker = L.marker([46.19157912229649, 7.383407800118581], {
            title: 'Trail Center'
        }).addTo(map)
        .bindPopup('<div class="trail-popup"><h4>üéØ Trail Center</h4><p>This marker shows the calculated center of the trail geometry.</p></div>');

        // Add Swiss topographic base layer
        const baseLayer = L.tileLayer('https://wmts.geo.admin.ch/1.0.0/ch.swisstopo.pixelkarte-farbe/default/current/3857/{z}/{x}/{y}.jpeg', {
            attribution: '&copy; <a href="https://www.swisstopo.admin.ch/">Swisstopo</a>',
            maxZoom: 18
        }).addTo(map);

        // Add MVT trail layer
        const mvtLayer = L.vectorGrid.protobuf('http://localhost:8090/api/mvt/trails?z={z}&x={x}&y={y}', {
            vectorTileLayerStyles: {
                'trails': function(properties, zoom) {
                    // Style trails based on difficulty level
                    const levelColors = {
                        'S0': '#2ecc71', // Green - Easy
                        'S1': '#f1c40f', // Yellow - Moderate  
                        'S2': '#e67e22', // Orange - Difficult
                        'S3': '#e74c3c', // Red - Very Difficult
                        'S4': '#8e44ad', // Purple - Extreme
                        'S5': '#2c3e50'  // Dark - Expert Only
                    };
                    
                    return {
                        weight: Math.max(2, 6 - zoom * 0.3), // Thicker lines at lower zoom
                        color: levelColors[properties.level] || '#3498db',
                        opacity: 0.8,
                        lineCap: 'round',
                        lineJoin: 'round'
                    };
                }
            },
            interactive: true,
            maxZoom: 18,
            getFeatureId: function(f) {
                return f.properties.id;
            }
        }).addTo(map);

        // Add click handlers for trail information
        mvtLayer.on('click', function(e) {
            if (e.layer && e.layer.properties) {
                const props = e.layer.properties;
                const levelColors = {
                    'S0': '#2ecc71', 'S1': '#f1c40f', 'S2': '#e67e22',
                    'S3': '#e74c3c', 'S4': '#8e44ad', 'S5': '#2c3e50'
                };
                
                const popupContent = `
                    <div class="trail-popup">
                        <h4>üöµ ${props.name}</h4>
                        <p><strong>Difficulty:</strong> <span class="trail-level" style="background-color: ${levelColors[props.level]}">${props.level}</span></p>
                        <p><strong>Trail ID:</strong> ${props.id}</p>
                        <p><em>Click and drag to explore the trail route</em></p>
                    </div>
                `;
                
                L.popup()
                    .setLatLng(e.latlng)
                    .setContent(popupContent)
                    .openOn(map);
            }
        });

        // Track tile loading statistics  
        mvtLayer.on('tileload', function(e) {
            tileLoadCount++;
            
            // Count features in this tile
            let tileFeatures = 0;
            if (e.tile._features) {
                Object.keys(e.tile._features).forEach(layerName => {
                    const features = e.tile._features[layerName];
                    tileFeatures += features.length;
                    console.log(`Tile ${e.coords.z}/${e.coords.x}/${e.coords.y} - Layer '${layerName}': ${features.length} features`);
                });
            } else {
                console.log(`Tile ${e.coords.z}/${e.coords.x}/${e.coords.y} - No _features property`);
            }
            
            totalFeatures += tileFeatures;
            updateStats();
        });

        // Log tile errors to identify decode failures
        mvtLayer.on('tileerror', function(e) {
            console.error(`Tile error for ${e.coords.z}/${e.coords.x}/${e.coords.y}:`, e.error);
        });

        // Control handlers
        document.getElementById('mvtLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(mvtLayer);
            } else {
                map.removeLayer(mvtLayer);
            }
        });

        document.getElementById('opacity').addEventListener('input', function() {
            const opacity = parseFloat(this.value);
            document.getElementById('opacityValue').textContent = opacity;
            
            // Update trail styles with new opacity
            mvtLayer.setFeatureStyle = function(layerName, feature) {
                const levelColors = {
                    'S0': '#2ecc71', 'S1': '#f1c40f', 'S2': '#e67e22',
                    'S3': '#e74c3c', 'S4': '#8e44ad', 'S5': '#2c3e50'
                };
                
                return {
                    weight: 3,
                    color: levelColors[feature.properties.level] || '#3498db',
                    opacity: opacity,
                    lineCap: 'round',
                    lineJoin: 'round'
                };
            };
            mvtLayer.redraw();
        });

        document.getElementById('showTrailCenter').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(trailMarker);
            } else {
                map.removeLayer(trailMarker);
            }
        });

        // Update statistics display
        function updateStats() {
            document.getElementById('tileCount').textContent = tileLoadCount;
            document.getElementById('featureCount').textContent = totalFeatures;
        }

        // Log successful initialization
        console.log('üöµ BikeMap MVT Demo initialized successfully!');
        console.log('Backend API: http://localhost:8090/api/mvt/trails');
        console.log('Map bounds set to trail area in Swiss Alps');
    </script>
</body>
</html>