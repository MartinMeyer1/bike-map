<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BikeMap MVT Enhanced Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!--
    BikeMap MVT Enhanced Demo
    
    This demo demonstrates the complete integration of enhanced Mapbox Vector Tiles (MVT) 
    with trail start/end markers. It serves as a reference implementation for the main frontend.
    
    Key Features:
    - Loads trail data from MVT tiles with complete metadata
    - Automatically creates start/end markers for all trails
    - Interactive popups showing comprehensive trail information
    - Real-time trail statistics and controls
    
    Important Technical Notes:
    1. Marker Creation: Markers MUST be created inside the vectorTileLayerStyles function,
       not in click events or tile loading events, due to Leaflet.VectorGrid limitations.
    2. The styling function gets called for each feature and has access to properties.
    3. This is the ONLY reliable way to access feature data for marker creation.
    -->
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #map { 
            height: 100vh; 
            width: 100%; 
        }
        
        .demo-header {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
        }
        
        .demo-header h2 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .demo-header p {
            margin: 0 0 10px 0;
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 200px;
        }
        
        .controls h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: #34495e;
            font-size: 14px;
        }
        
        .control-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }
        
        .opacity-display {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .stats {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .trail-popup {
            font-family: inherit;
        }
        
        .trail-popup h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
        }
        
        .trail-popup .trail-level {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="demo-header">
        <h2>üöµ BikeMap MVT Enhanced Demo</h2>
        <p>Reference implementation showing enhanced Mountain Bike Vector Tiles with automatic trail markers.</p>
        <p><strong>Features:</strong> Trails with metadata, automatic start/end markers, interactive popups, and real-time statistics.</p>
        <p><em>Automatic markers:</em></p>
        <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px;">
            <li><strong>üöÄ Green circles</strong> - Trail start points</li>
            <li><strong>üèÅ Red circles</strong> - Trail end points</li>
            <li><strong>üìä Click trails</strong> - View complete metadata</li>
            <li><strong>üìç Click markers</strong> - View coordinates</li>
        </ul>
    </div>
    
    <div class="controls">
        <h3>‚öôÔ∏è Controls</h3>
        
        <div class="control-group">
            <label>
                <input type="checkbox" id="mvtLayer" checked>
                Show Trail Layer
            </label>
        </div>
        
        <div class="control-group">
            <label>
                Trail Opacity: <span class="opacity-display" id="opacityValue">0.8</span>
            </label>
            <input type="range" id="opacity" min="0" max="1" step="0.1" value="0.8">
        </div>
        
        <div class="control-group">
            <label>
                <input type="checkbox" id="showTrailCenter" checked>
                Show Trail Marker
            </label>
        </div>
        
        <div class="control-group">
            <label style="font-weight: bold; color: #2c3e50; margin-bottom: 10px;">
                MVT Endpoint:
            </label>
            <label style="font-size: 12px; color: #7f8c8d;">
                /api/tiles/{z}/{x}/{y}.mvt
            </label>
        </div>
    </div>
    
    <div class="stats" id="stats">
        <div>Tiles loaded: <span id="tileCount">0</span></div>
        <div>Trail markers: <span id="featureCount">0</span></div>
        <div>Backend: localhost:8090</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>
    
    <script>
        /*
         * BikeMap MVT Enhanced Demo - JavaScript Implementation
         * 
         * This script demonstrates the proper way to integrate MVT trails with automatic markers.
         * 
         * Architecture:
         * 1. Initialize Leaflet map with Swiss coordinates
         * 2. Add Swiss topographic base layer  
         * 3. Create MVT layer with proper styling function
         * 4. CRITICAL: Create markers inside the styling function (see createMarkersForTrail)
         * 5. Handle click events for detailed trail information
         * 
         * Key Technical Insights:
         * - Leaflet.VectorGrid only provides feature access in the styling function
         * - Attempting to create markers in tile events or click handlers fails
         * - The styling function is called once per feature and has reliable property access
         */

        // Statistics tracking
        let tileLoadCount = 0;
        
        // Initialize map centered on trail area (Swiss Alps coordinates)
        const map = L.map('map').fitBounds([[46.029985, 6.93462], [46.28743, 7.832396]]);


        // Add Swiss topographic base layer
        const baseLayer = L.tileLayer('https://wmts.geo.admin.ch/1.0.0/ch.swisstopo.pixelkarte-farbe/default/current/3857/{z}/{x}/{y}.jpeg', {
            attribution: '&copy; <a href="https://www.swisstopo.admin.ch/">Swisstopo</a>',
            maxZoom: 18
        }).addTo(map);

        // Create MVT layer
        let currentMVTLayer;
        
        function createMVTLayer() {
            const url = 'http://localhost:8090/api/tiles/{z}/{x}/{y}.mvt';
            console.log('üîß Creating MVT layer with URL:', url);
            
            // Test a direct fetch to verify connectivity
            fetch('http://localhost:8090/api/tiles/10/532/363.mvt')
                .then(response => {
                    console.log('üåê Direct fetch test - Status:', response.status, 'Size:', response.headers.get('content-length'));
                    if (!response.ok) {
                        console.error('‚ùå Direct fetch failed:', response.statusText);
                    }
                })
                .catch(error => console.error('‚ùå Direct fetch error:', error));
            
            console.log('üîß Creating L.vectorGrid.protobuf...');
            const layer = L.vectorGrid.protobuf(url, {
                vectorTileLayerStyles: {
                    'trails': function(properties, zoom) {
                        console.log('üé® Styling trail:', properties);
                        
                        // Create markers for this trail when it's being styled
                        createMarkersForTrail(properties);
                        
                        const levelColors = {
                            'S0': '#28a745', 'S1': '#007bff', 'S2': '#fd7e14',
                            'S3': '#dc3545', 'S4': '#6f42c1', 'S5': '#343a40'
                        };
                        
                        return {
                            weight: 6,
                            color: levelColors[properties.level] || '#00ccff',
                            opacity: 0.9,
                            lineCap: 'round',
                            lineJoin: 'round'
                        };
                    }
                },
                interactive: true,
                maxZoom: 18,
                attribution: 'BikeMap Enhanced MVT Backend'
            });
            
            console.log('‚úÖ L.vectorGrid.protobuf created');
            return layer;
        }
        
        // Initialize and add MVT layer to map
        currentMVTLayer = createMVTLayer().addTo(map);

        // Helper functions for formatting
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatDistance(meters) {
            if (!meters) return 'N/A';
            return meters >= 1000 ? `${(meters/1000).toFixed(1)} km` : `${Math.round(meters)} m`;
        }

        function formatElevation(meters) {
            return meters !== undefined && meters !== null ? `${Math.round(meters)}m` : 'N/A';
        }

        function formatCoordinate(lat, lng) {
            if (lat === undefined || lng === undefined) return 'N/A';
            return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        }

        /*
         * TRAIL MARKER SYSTEM
         * 
         * This system automatically creates start/end markers for all trails loaded from MVT.
         * 
         * CRITICAL IMPLEMENTATION NOTE:
         * The createMarkersForTrail function MUST be called from within the vectorTileLayerStyles
         * function below. This is the ONLY way to reliably access feature properties in 
         * Leaflet.VectorGrid. Other approaches (tile events, click handlers) will fail.
         */
        
        // Storage for trail markers to prevent duplicates
        const allTrailMarkers = new Map(); // trail ID -> {startMarker, endMarker}
        
        /**
         * Creates start and end markers for a single trail
         * 
         * @param {Object} props - Trail properties from MVT feature
         * @param {string} props.id - Unique trail identifier
         * @param {string} props.name - Trail name
         * @param {number} props.start_lat - Start point latitude
         * @param {number} props.start_lng - Start point longitude  
         * @param {number} props.end_lat - End point latitude
         * @param {number} props.end_lng - End point longitude
         */
        function createMarkersForTrail(props) {
            // Validate required properties
            if (!props.id || !props.start_lat || !props.start_lng || !props.end_lat || !props.end_lng) {
                return;
            }
            
            // Prevent duplicate markers for the same trail
            if (allTrailMarkers.has(props.id)) {
                return;
            }
            
            // Create start marker (green circle)
            const startMarker = L.marker([props.start_lat, props.start_lng], {
                title: `${props.name} - Start`,
                icon: L.divIcon({
                    className: 'trail-start-marker',
                    html: '<div style="background: #22c55e; border: 2px solid white; border-radius: 50%; width: 16px; height: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8],
                })
            }).addTo(map)
            .bindPopup(`
                <div style="text-align: center;">
                    <strong>üöÄ ${props.name}</strong><br>
                    <em>Trail Start</em><br>
                    <small>${props.start_lat.toFixed(6)}, ${props.start_lng.toFixed(6)}</small>
                </div>
            `);

            // Create end marker (red circle)
            const endMarker = L.marker([props.end_lat, props.end_lng], {
                title: `${props.name} - End`,
                icon: L.divIcon({
                    className: 'trail-end-marker',
                    html: '<div style="background: #ef4444; border: 2px solid white; border-radius: 50%; width: 16px; height: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8],
                })
            }).addTo(map)
            .bindPopup(`
                <div style="text-align: center;">
                    <strong>üèÅ ${props.name}</strong><br>
                    <em>Trail End</em><br>
                    <small>${props.end_lat.toFixed(6)}, ${props.end_lng.toFixed(6)}</small>
                </div>
            `);

            // Store markers to prevent duplicates and enable management
            allTrailMarkers.set(props.id, { startMarker, endMarker });
        }

        /*
         * TRAIL CLICK HANDLER
         * 
         * Handles clicks on trail lines to show detailed information popup.
         * This displays all enhanced metadata from the MVT backend.
         */
        function setupLayerEvents(layer) {
            layer.on('click', function(e) {
                if (e.layer && e.layer.properties) {
                    const props = e.layer.properties;
                    
                    const levelColors = {
                        'S0': '#00ff88', 'S1': '#ffff00', 'S2': '#ff8800',
                        'S3': '#ff0044', 'S4': '#cc00ff', 'S5': '#ff0099'
                    };
                    
                    const popupContent = `
                        <div style="font-family: Arial, sans-serif; max-width: 400px; line-height: 1.4;">
                            <div style="border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 12px;">
                                <h3 style="margin: 0; color: #2c3e50;">${props.name || 'Unnamed Trail'}</h3>
                                <span class="trail-level" style="background-color: ${levelColors[props.level]}; display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; margin-top: 4px;">
                                    ${props.level || 'Unknown'}
                                </span>
                            </div>

                            ${props.description ? `
                                <div style="margin-bottom: 12px;">
                                    <strong>Description:</strong><br>
                                    <span style="color: #666; font-size: 12px;">${props.description}</span>
                                </div>
                            ` : ''}

                            <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 12px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #2c3e50;">üìä Trail Statistics</h4>
                                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                    ${props.distance_m ? `
                                        <div><strong>üìè Distance:</strong> ${formatDistance(props.distance_m)}</div>
                                    ` : ''}
                                    ${props.elevation_gain_meters ? `
                                        <div><strong>‚¨ÜÔ∏è Gain:</strong> +${formatElevation(props.elevation_gain_meters)}</div>
                                    ` : ''}
                                    ${props.elevation_loss_meters ? `
                                        <div><strong>‚¨áÔ∏è Loss:</strong> -${formatElevation(props.elevation_loss_meters)}</div>
                                    ` : ''}
                                </div>
                            </div>

                            <div style="background: #e8f4f8; padding: 8px; border-radius: 4px; margin-bottom: 12px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #2c3e50;">üèîÔ∏è Elevation Profile</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                    <div><strong>Min:</strong> ${formatElevation(props.min_elevation_meters)}</div>
                                    <div><strong>Max:</strong> ${formatElevation(props.max_elevation_meters)}</div>
                                    <div><strong>Start:</strong> ${formatElevation(props.elevation_start_meters)}</div>
                                    <div><strong>End:</strong> ${formatElevation(props.elevation_end_meters)}</div>
                                </div>
                            </div>

                            <div style="background: #f0f8f0; padding: 8px; border-radius: 4px; margin-bottom: 12px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #2c3e50;">üìç Geographic Data</h4>
                                <div style="font-size: 12px;">
                                    <div><strong>Start Point:</strong> ${formatCoordinate(props.start_lat, props.start_lng)}</div>
                                    <div><strong>End Point:</strong> ${formatCoordinate(props.end_lat, props.end_lng)}</div>
                                    <div style="margin-top: 4px;"><strong>Bounding Box:</strong></div>
                                    <div style="margin-left: 8px;">
                                        N: ${props.bbox_north ? props.bbox_north.toFixed(6) : 'N/A'} | 
                                        S: ${props.bbox_south ? props.bbox_south.toFixed(6) : 'N/A'}<br>
                                        E: ${props.bbox_east ? props.bbox_east.toFixed(6) : 'N/A'} | 
                                        W: ${props.bbox_west ? props.bbox_west.toFixed(6) : 'N/A'}
                                    </div>
                                </div>
                            </div>

                            <div style="background: #fff8e1; padding: 8px; border-radius: 4px; font-size: 12px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #2c3e50;">‚ÑπÔ∏è Metadata</h4>
                                <div><strong>ID:</strong> ${props.id || 'N/A'}</div>
                                <div><strong>Owner ID:</strong> ${props.owner_id || 'N/A'}</div>
                                <div><strong>Created:</strong> ${formatDate(props.created_at)}</div>
                                <div><strong>Updated:</strong> ${formatDate(props.updated_at)}</div>
                                ${props.gpx_file ? `<div><strong>GPX File:</strong> ${props.gpx_file}</div>` : ''}
                                ${props.tags ? `<div><strong>Tags:</strong> ${props.tags}</div>` : ''}
                            </div>

                            <div style="margin-top: 8px; font-size: 10px; color: #888; text-align: center;">
                                Enhanced MVT Backend - All metadata included in tiles
                            </div>
                        </div>
                    `;
                    
                    L.popup({
                        maxWidth: 450,
                        className: 'enhanced-trail-popup'
                    })
                        .setLatLng(e.latlng)
                        .setContent(popupContent)
                        .openOn(map);
                }
            });

            // Track tile loading statistics
            layer.on('tileload', function(e) {
                tileLoadCount++;
                updateStats();
            });

            // Handle tile loading errors
            layer.on('tileerror', function(e) {
                console.error(`Tile loading failed for ${e.coords.z}/${e.coords.x}/${e.coords.y}:`, e.error);
            });

            // Add tile loading start event
            layer.on('tileloadstart', function(e) {
                console.log(`üöÄ Starting to load tile ${e.coords.z}/${e.coords.x}/${e.coords.y}`);
                console.log('üîó Tile URL:', e.tile.src);
            });
        }
        
        // Setup click events for trail information
        setupLayerEvents(currentMVTLayer);


        // Control handlers
        document.getElementById('mvtLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(currentMVTLayer);
            } else {
                map.removeLayer(currentMVTLayer);
            }
        });
        

        document.getElementById('opacity').addEventListener('input', function() {
            const opacity = parseFloat(this.value);
            document.getElementById('opacityValue').textContent = opacity;
            
            // Update trail styles with new opacity
            currentMVTLayer.setFeatureStyle = function(layerName, feature) {
                const levelColors = {
                    'S0': '#00ff88', 'S1': '#ffff00', 'S2': '#ff8800',
                    'S3': '#ff0044', 'S4': '#cc00ff', 'S5': '#ff0099'
                };
                
                return {
                    weight: 6, // Thicker lines for opacity control too
                    color: levelColors[feature.properties.level] || '#00ccff',
                    opacity: opacity,
                    lineCap: 'round',
                    lineJoin: 'round'
                };
            };
            currentMVTLayer.redraw();
        });

        document.getElementById('showTrailCenter').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(trailMarker);
            } else {
                map.removeLayer(trailMarker);
            }
        });

        // Update statistics display
        function updateStats() {
            document.getElementById('tileCount').textContent = tileLoadCount;
            document.getElementById('featureCount').textContent = allTrailMarkers.size;
        }

        // Initialization complete
        console.log('BikeMap MVT Enhanced Demo initialized');
        console.log('Backend API:', 'http://localhost:8090/api/tiles/{z}/{x}/{y}.mvt');
        console.log('Trail markers will appear automatically as tiles load');
    </script>
</body>
</html>