# BikeMap Production Deployment Guide

This guide will help you deploy the professional BikeMap application to a VPS using Docker, PostGIS, and Traefik for high-performance vector tile serving.

## Prerequisites

- A VPS with Ubuntu/Debian (minimum 2GB RAM recommended for PostGIS)
- A domain name (e.g., bike-map.ch) pointing to your VPS IP
- Google OAuth 2.0 credentials from Google Cloud Console
- Docker and Docker Compose installed locally for building images
- SSH access to your VPS

## Quick Start

### 1. Prepare Your Local Environment

```bash
# Clone the repository (if not already done)
cd bike-map

# Copy and configure production environment
cp .env.production.example .env.production
# Edit .env.production with your values
```

### 2. Configure Environment Variables

Edit `.env.production` with your values:

```env
# Domain & SSL
BASE_DOMAIN=bike-map.ch
ACME_EMAIL=your-email@example.com

# Authentication
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
ADMIN_EMAIL=admin@bike-map.ch
ADMIN_PASSWORD=your_secure_admin_password_here

# Backend Configuration
BASE_URL=http://localhost:8090

# PostGIS Database
POSTGRES_HOST=postgis
POSTGRES_PORT=5432
POSTGRES_DB=gis
POSTGRES_USER=gisuser
POSTGRES_PASSWORD=your_secure_postgres_password_here

# Frontend URLs
VITE_API_BASE_URL=https://bike-map.ch/api
VITE_BROUTER_BASE_URL=https://bike-map.ch/brouter

# ADMIN_PASSWORD_HASH will be auto-generated by build script
```

**Important**: 
- Ensure you use a strong password for the admin account
- Use a strong, unique password for the PostGIS database
- The same admin credentials protect both PocketBase admin interface and Traefik dashboard
- The build script automatically generates the required password hash for Traefik

### 3. Setup Your VPS

Ensure Docker and Docker Compose are installed on your VPS:

```bash
# Install Docker (Ubuntu/Debian)
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Install htpasswd for password hashing (required locally)
sudo apt-get update
sudo apt-get install apache2-utils

# Verify installation
docker --version
docker compose version
htpasswd -h
```

### 4. Build and Deploy

```bash
# Make scripts executable
chmod +x scripts/build.sh scripts/deploy.sh

# Build the application locally
./scripts/build.sh

# Deploy to your VPS
./scripts/deploy.sh
```

The deployment script will:
- Generate password hash for Traefik dashboard authentication
- Transfer Docker images to your VPS
- Copy configuration files and database initialization scripts
- Start services including PostGIS database
- Automatically obtain SSL certificates
- Initialize PostGIS database with spatial tables and indexes

## Manual Deployment Steps

If you prefer to deploy manually:

### 1. Build Docker Images

```bash
# Build backend
docker build -t bikemap-backend:latest ./backend

# Build frontend with production API URL
docker build \
    --build-arg VITE_API_BASE_URL=https://bike-map.ch \
    -t bikemap-frontend:latest \
    ./frontend

# Save images
docker save bikemap-backend:latest | gzip > bikemap-backend.tar.gz
docker save bikemap-frontend:latest | gzip > bikemap-frontend.tar.gz
```

### 2. Transfer to VPS

```bash
# Create deployment directory on VPS
ssh root@your-vps "mkdir -p /opt/bikemap"

# Upload images, config, and database initialization
scp bikemap-*.tar.gz docker-compose.yml .env.production root@your-vps:/opt/bikemap/
scp -r mvt-server/ root@your-vps:/opt/bikemap/
```

### 3. Deploy on VPS

```bash
ssh root@your-vps
cd /opt/bikemap

# Load images
docker load < bikemap-backend.tar.gz
docker load < bikemap-frontend.tar.gz

# Rename environment file
mv .env.production .env

# Create required directories
mkdir -p pb_data letsencrypt

# Start services (PostGIS will initialize automatically)
docker compose up -d

# Check status and wait for PostGIS to be ready
docker compose ps
docker compose logs -f postgis

# Verify services are healthy
docker compose logs backend
```

## Service Architecture

The deployment uses a professional multi-service architecture:

- **Traefik** (Reverse proxy with automatic SSL)
  - Port 80 (HTTP - redirects to HTTPS)
  - Port 443 (HTTPS)
  - Dashboard: `https://proxy.bike-map.ch`

- **PostGIS** (Spatial database)
  - PostgreSQL 15 with PostGIS 3.4 extension
  - Automatic spatial table creation and indexing
  - Vector tile generation with ST_AsMVT()
  - Data persisted in `postgis_data` volume

- **Backend** (Professional Go service)
  - API routes: `https://bike-map.ch/api/*`
  - Vector tiles: `https://bike-map.ch/api/tiles/{z}/{x}/{y}.mvt`
  - Admin interface: `https://admin.bike-map.ch`
  - Clean architecture with service separation
  - PocketBase data persisted in `./pb_data` volume

- **Frontend** (React SPA)
  - Main application: `https://bike-map.ch`
  - Vector tile layer integration
  - Hybrid rendering support
  - Served by Nginx

## SSL/TLS Configuration

Traefik automatically obtains SSL certificates from Let's Encrypt for your domain. Make sure:

1. Your domain points to your VPS IP
2. Ports 80 and 443 are accessible
3. The ACME_EMAIL is set correctly in your `.env.production`

## Google OAuth Configuration

Update your Google OAuth settings:

1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Edit your OAuth Client ID
3. Update authorized redirect URIs to include:
   ```
   https://bike-map.ch/api/oauth2-redirect
   ```

## Monitoring and Logs

```bash
# View service status
docker compose ps

# View logs for all services
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f traefik
docker compose logs -f postgis

# Monitor PostGIS database
docker compose exec postgis psql -U gisuser -d gis -c "SELECT COUNT(*) FROM trails;"

# Access dashboards
# Traefik: https://proxy.bike-map.ch
# PocketBase Admin: https://admin.bike-map.ch
```

## Updating the Application

To update your deployment:

```bash
# Local: Build new images
./scripts/build.sh

# Deploy updates
./scripts/deploy.sh
```

## Backup

Important directories to backup:
- `/opt/bikemap/pb_data/` - PocketBase database and uploaded GPX files
- `/opt/bikemap/postgis_data/` - PostGIS spatial database (Docker volume)
- `/opt/bikemap/letsencrypt/` - SSL certificates

```bash
# Backup script example
# Stop services first for consistent backup
docker compose stop

# Backup application data
tar -czf bikemap-backup-$(date +%Y%m%d).tar.gz \
    /opt/bikemap/pb_data/ \
    /opt/bikemap/letsencrypt/

# Backup PostGIS database
docker compose run --rm postgis pg_dump -U gisuser -d gis > bikemap-postgis-backup-$(date +%Y%m%d).sql

# Restart services
docker compose start
```

## Troubleshooting

### SSL Certificate Issues
```bash
# Check Traefik logs
docker compose logs traefik

# Restart Traefik to retry certificate
docker compose restart traefik
```

### PostGIS Database Issues
```bash
# Check PostGIS logs
docker compose logs postgis

# Access PostGIS database
docker compose exec postgis psql -U gisuser -d gis

# Verify PostGIS extension
docker compose exec postgis psql -U gisuser -d gis -c "SELECT PostGIS_Version();"

# Check spatial tables
docker compose exec postgis psql -U gisuser -d gis -c "\dt"
```

### Backend Service Issues
```bash
# Check backend logs
docker compose logs backend

# Access backend container
docker compose exec backend sh

# Verify PostGIS connection from backend
docker compose logs backend | grep -i postgis
```

### Vector Tile Issues
```bash
# Test MVT endpoint directly
curl -I "https://bike-map.ch/api/tiles/14/8580/5734.mvt"

# Check cache invalidation logs
docker compose logs backend | grep -i cache
```

### Frontend Build Issues
Make sure `VITE_API_BASE_URL` is set correctly when building the frontend image.

## Security Notes

- **Traefik dashboard**: Protected with basic authentication at `https://proxy.bike-map.ch`
  - Username: Your `ADMIN_EMAIL` 
  - Password: Your `ADMIN_PASSWORD`
- **PocketBase admin interface**: Protected with admin account at `https://admin.bike-map.ch`
  - Same credentials as above
- **PostGIS database**: Only accessible internally via Docker network
  - Strong password required for `POSTGRES_PASSWORD`
  - Automatic backups recommended
- **SSL/HTTPS**: Automatic certificate management via Let's Encrypt
- **Vector tile caching**: Automatic invalidation prevents stale data
- **Regular backups**: Critical for both PocketBase and PostGIS data
- **Updates**: Keep Docker images updated regularly
- **Network isolation**: Services communicate via internal Docker network

## Support

For issues with deployment, check the logs and ensure all environment variables are set correctly.